<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset=utf-8>
    <meta http-equiv=X-UA-Compatible content="IE=edge">
    <meta name=viewport content="width=device-width,initial-scale=1">
    <link rel=icon href=assets/favicon.ico>
    <link rel="stylesheet" type="text/css" href="css/style.css"/>
<!--    <script src="https://d3js.org/d3.v6.min.js"></script>-->
    <script type="text/javascript" src="js/brainstorm.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.1/socket.io.min.js" integrity="sha512-/WwtKR6NnHomLo0O4w9QKc1INTPEJs7ko6u2aBTA1paPldhPl8LtXsi7a35iEZ69+9P5dcgVNESG8hrP4Y2t3w==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bcijs@1.8.0/dist/bci.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.1.9/lib/p5.js"></script>

    <title>Brainstorm</title>
</head>
<body onload="initialize()">
<noscript>
    <strong>We're sorry but Mousai Neurotechnologies doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
</noscript>

<div id=app>
<div id="brainstorm">
<div>
    <div id="p5Canvas"></div>
</div>
<div id="tutorial">
    <div id="tutorial-text">
        <h1>Welcome to Brainstorm!</h1>
        <div class="tut-div">
            <p>Experience a social neurotechnology platform that enables you to manage your brain data and couple with other minds across social, cultural, and political boundaries.</p>
        </div>
        <div id="'tut-buttons">
            <button id="close-tutorial" onclick="closeTutorial()">Close Tutorial</button>
            <div class="break"></div>
            <button class="gray-button"  onclick="window.location.href='./index.html'">Back to Main Site</button>
        </div>
    </div>
</div>
<div id="parameters">
    <div>
        <button id="open-tutorial" onclick="openTutorial()">Open Tutorial</button>
        <button class="gray-button" onclick="window.location.href='./index.html'">Back to Main Site</button>
        <button class="purple-button"  onclick="generateSignal()">Generate Signal</button>
    </div>
<!--    <div>-->
<!--        <p>Frequency: {{ rangeSlider }}</p>-->
<!--        <input v-model="rangeSlider" type="range" min="1" max="100" class="slider" id="myRange">-->
<!--    </div>-->
<!--    <div>-->
<!--        <p>Filter: {{ minFilter }} - {{ maxFilter }}</p>-->
<!--        <input v-model="minFilter" type="range" min="1" max="100" class="slider" id="min">-->
<!--        <input v-model="maxFilter" type="range" min="1" max="100" class="slider" id="max">-->
<!--    </div>-->
</div>
<div id="chat">
    <ul id="messages"></ul>
    <form action="" onsubmit="sendMessage()">
        <!--            <div class="gorm-group">-->
        <!--                <label for="user">User:</label>-->
        <!--                <input type="text" v-model="user" class="form-control">-->
        <!--            </div>-->
            <label for="message"></label>
            <input type="text" id="message" autocomplete="off" />
        <button id="chat-button">Send</button>
    </form>
</div>
</div>
</div>

<script>
    let yvalues = new Array(200).fill(0);
    let other_yvalues = new Array(yvalues.length).fill(0);
    let basetime = new Array(yvalues.length).fill(Date.now());
    let other_basetime = new Array(yvalues.length).fill(Date.now());

    let signal = [];

    let samplerate = 125; // This is almost definitely wrong

    let rangeSlider = 10

    let filterOrder = 128;

    let messages = []
    let socket = io.connect(('https://mousai.azurewebsites.net/'))

    $(function () {
        $('form').submit(function(e) {
            e.preventDefault(); // prevents page reloading
            socket.emit('chat message', $('#message').val());
            $('#message').val('');
            return false;
        });
    });

    function initialize() {

        socket.on('chat message', (data) => {
            messages = [...messages, data];
            // you can also do this.messages.push(data)
        });

        socket.on('chat message', function (msg) {
            $('#messages').append($('<li>').text(msg));
        });

        let passed_signal = []
        let passed_time = []

        socket.on('bci', passSignal);

        function passSignal(data) {
            passed_signal = data.signal
            passed_time = data.time
            console.log('Signal passed')
        }

        new p5(function (p5) {
            // let start_time = Date.now();
            let first_sig = true;
            let in_min
            let in_max
            let out_min
            let out_max
            let t_inner
            let y1
            let basetime_package
            let signal_package
            let time_package
            let y_package
            let label_package = ['me', 'other'];
            let color_package = [p5.color('#7373FF'), p5.color('#76BEFF')]
            let synchrony;
            let sync_color = p5.color('#76BEFF')
            let antisync_color = p5.color('#FF76E9')
            let band_color = p5.color('#7373FF')


            p5.setup = () => {
                let canvas = p5.createCanvas(p5.windowWidth - 350, p5.windowHeight);
                canvas.parent("p5Canvas");
            }

            p5.draw = () => {
                p5.background(0);
                p5.translate(0, p5.height / 2);
                if (signal.length > 0) {
                    signal_package = [signal[0], passed_signal];
                } else {
                    signal_package = [signal, passed_signal];
                }
                time_package = [passed_time, passed_time];
                y_package = [yvalues, other_yvalues];
                basetime_package = [basetime, other_basetime]

                // if ((Array.isArray(signal) && signal.length) && (Array.isArray(passed_signal) && passed_signal.length)){
                synchrony = getPearsonCorrelation(yvalues, other_yvalues)
                // }


                processSignal(signal_package, time_package, y_package, basetime_package, label_package, color_package)
            }

            function calcWave(sig, t, yvals, bt) {
                bt.shift();
                yvals.shift();
                if (sig.length > 0) {
                    if (first_sig) {
                        // start_time = Date.now();
                        first_sig = false;
                    }
                    yvals.push(sig.shift())
                    bt.push(Date.now()) //start_time + t.shift())
                } else {
                    yvals.push(0)
                    bt.push(Date.now()) // bt.push(Date.now()-start_time)
                }

                return sig, t, yvals, bt
            }

            function renderWave(yvals, bt, usr, c) {
                // A simple way to draw the wave with an ellipse at each location
                // c.setAlpha(100)

                // Filter
                let y_filtered = yvals //filterSignal(yvals)


                // Map to Window Size
                p5.stroke(c);
                p5.strokeWeight(2);
                in_min = Math.min(...bt);
                in_max = Math.max(...bt);
                out_min = 0;
                out_max = p5.width;
                t_inner = bt.map(x => (x - in_min) * (out_max - out_min) / (in_max - in_min) + out_min)

                for (let ind = 0; ind < y_filtered.length - 1; ind++) {
                    y1 = y_filtered[ind]
                    p5.push()
                    p5.scale(1, -1);
                    p5.line(t_inner[ind], y1, t_inner[ind + 1], y_filtered[ind + 1]);
                    p5.pop()
                }
                // let diffs = 0;
                // for (let ii = 0; ii < bt.length-1;ii++){
                //     diffs += (bt[ii+1] - bt[ii])
                // }
                // let diff = diffs/(bt.length-1)
                if (usr == 'me') {
                    let band_names = ['delta', 'theta', 'alpha', 'beta', 'gamma']
                    let band_meaning = ['(1-3 Hz)','(4-7 Hz)','(8-12 Hz)','(13-30 Hz)','(31-50 Hz)']
                    let bandpowers = bci.bandpower(y_filtered, samplerate, band_names, {relative: true});
                    let pos;
                    p5.noStroke()
                    let squareColor = p5.color(255, 255, 255);
                    p5.textAlign(p5.CENTER, p5.BOTTOM);
                    for (let band = 0; band < bandpowers.length; band++) {
                        pos = (p5.height / 2) - (p5.height / 4) * (bandpowers[band])
                        squareColor.setAlpha(255 * (bandpowers[band]));
                        p5.fill(squareColor)
                        p5.text(band_names[band] + ' ' + band_meaning[band], (band + .5) * (p5.width / band_names.length), pos - 20)
                        band_color.setAlpha(200 * (bandpowers[band]));
                        p5.fill(band_color)
                        p5.rectMode(p5.CORNERS);
                        p5.rect(band * (p5.width / (band_names.length)), p5.height / 2, (band + 1) * (p5.width / (band_names.length)), pos)
                    }

                    squareColor.setAlpha(255);
                    p5.fill(squareColor)
                    // Calculate Synchrony
                    p5.text('Synchrony', 5 * p5.width / 6, (-p5.height / 4) + 50);
                    console.log(synchrony)
                    if (synchrony != 1 && !isNaN(synchrony)) {
                        if (synchrony > 0) {
                            sync_color.setAlpha(200*Math.abs(synchrony))
                            p5.fill(sync_color)
                        } else {
                            antisync_color.setAlpha(200*Math.abs(synchrony))
                            p5.fill(antisync_color)
                        }
                        p5.ellipse(5 * p5.width / 6, -p5.height / 4, synchrony * 50, synchrony * 50);
                    }
                }
            }

            function processSignal(sig, t, yvals, bt, usr, col) {
                for (let ind in sig) {
                    sig[ind], t[ind], yvals[ind], bt[ind] = calcWave(sig[ind], t[ind], yvals[ind], bt[ind]);
                    renderWave(yvals[ind], bt[ind], usr[ind], col[ind]);
                }
                return sig, t, yvals, bt
            }
        })
    }

        /*
        *  Source: http://stevegardner.net/2012/06/11/javascript-code-to-calculate-the-pearson-correlation-coefficient/
        */
        function getPearsonCorrelation(x, y) {
            var shortestArrayLength = 0;

            if (x.length == y.length) {
                shortestArrayLength = x.length;
            } else if (x.length > y.length) {
                shortestArrayLength = y.length;
                console.error('x has more items in it, the last ' + (x.length - shortestArrayLength) + ' item(s) will be ignored');
            } else {
                shortestArrayLength = x.length;
                console.error('y has more items in it, the last ' + (y.length - shortestArrayLength) + ' item(s) will be ignored');
            }

            var xy = [];
            var x2 = [];
            var y2 = [];

            for (var i = 0; i < shortestArrayLength; i++) {
                xy.push(x[i] * y[i]);
                x2.push(x[i] * x[i]);
                y2.push(y[i] * y[i]);
            }

            var sum_x = 0;
            var sum_y = 0;
            var sum_xy = 0;
            var sum_x2 = 0;
            var sum_y2 = 0;

            for (var i = 0; i < shortestArrayLength; i++) {
                sum_x += x[i];
                sum_y += y[i];
                sum_xy += xy[i];
                sum_x2 += x2[i];
                sum_y2 += y2[i];
            }

            var step1 = (shortestArrayLength * sum_xy) - (sum_x * sum_y);
            var step2 = (shortestArrayLength * sum_x2) - (sum_x * sum_x);
            var step3 = (shortestArrayLength * sum_y2) - (sum_y * sum_y);
            var step4 = Math.sqrt(step2 * step3);
            var answer = step1 / step4;

            return answer;
        }
</script>

</body>
</html>

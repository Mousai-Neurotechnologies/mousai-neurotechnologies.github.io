<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset=utf-8>
    <meta http-equiv=X-UA-Compatible content="IE=edge">
    <meta name=viewport content="width=device-width,initial-scale=1">
    <link rel=icon href=assets/favicon.ico>
    <link rel="stylesheet" type="text/css" href="css/style.css"/>
<!--    <script src="https://d3js.org/d3.v6.min.js"></script>-->
    <script type="text/javascript" src="js/webgl.js" defer></script>
    <script type="text/javascript" src="js/utils.js" defer></script>
    <script type="text/javascript" src="js/gl-matrix-min.js" defer></script>
    <script type="text/javascript" src="js/point-functions.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.1/socket.io.min.js" integrity="sha512-/WwtKR6NnHomLo0O4w9QKc1INTPEJs7ko6u2aBTA1paPldhPl8LtXsi7a35iEZ69+9P5dcgVNESG8hrP4Y2t3w==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bcijs@1.8.0/dist/bci.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.1.9/lib/p5.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">

    <title>Brainstorm</title>
</head>
<body onload="initialize()" style="overflow: hidden">
<!--<body style="overflow: hidden">-->
<noscript>
    <strong>We're sorry but Mousai Neurotechnologies doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
</noscript>

<div id=app>

    <!--Navbar-->
    <div id="app-menu">
        <div id="menu-toggle" class="toggle"><div class="icon"><i class="fas fa-angle-right fa-3x"></i></div></div>
        <div class="icon"><a href="./index.html" class="img"><img alt="Mousai Neurotechnologies" src="assets/logo_long.png"></a></div>
        </a>
        <div class="icon" onclick="openTutorial()">
        <a><i class="fas fa-book-open fa-2x"></i></a><p>Tutorial</p>
        </div>
        <div class="icon" onclick="window.open('https://github.com/Mousai-Neurotechnologies/brainstorm-client','mywindow');">
            <a><i class="fab fa-python fa-2x"></i></a><p>Python Client</p>
        </div>
    </div>

    <!-- Chat Bar-->
    <div id="chat">
        <div id="chat-toggle" class="toggle"><div class="icon"><i class="fas fa-paper-plane fa-2x"></i></div></div>
        <ul id="messages"></ul>
        <form action="">
            <!--            <div class="gorm-group">-->
            <!--                <label for="user">User:</label>-->
            <!--                <input type="text" v-model="user" class="form-control">-->
            <!--            </div>-->
            <label for="message"></label>
            <input type="text" id="message" autocomplete="off" placeholder="Type message here..."/>
            <!--        <button id="chat-button" onclick="generateSignal()">-->
            <!--            <i class="fas fa-paper-plane fa-2x"></i>-->
            <!--            Send-->
            <!--        </button>-->
        </form>
    </div>

<div id="brainstorm">
<div id="canvas-container">
    <canvas id='webgl'></canvas>
</div>
<div id="tutorial">
    <div id="tutorial-text">
        <i class="fas fa-brain fa-3x"></i>
        <h1>Welcome to Brainstorm!</h1>
        <div class="tut-div">
            <p>Experience a social neurotechnology platform that enables you to manage your brain data and couple with other minds across social, cultural, and political boundaries.</p>
        </div>
        <div id="'tut-buttons">
            <button id="close-tutorial" onclick="closeTutorial()">
                <i class="fas fa-book fa-2x"></i>
                Close Tutorial
            </button>
        </div>
    </div>
</div>
<div id="parameters">
    <div id="param-toggle" class="toggle"><div class="icon"><i class="fas fa-magic fa-2x"></i></div></div>
    <div >
        <div>
            <button onclick="sendSignal(channels)">
                <i class="fas fa-wave-square fa-2x"></i>
                <p>Send Signal</p>
            </button>
        </div>
        <div>
            <button id="auto-generate" onclick=" generate = generateSignal(generate,channels)">
                <i class="fas fa-play-circle fa-2x"></i>
                <p>Autoplay Signal</p>
            </button>
        </div>
        <div class="flex wrap bound center">
            <p class="bound">Frequency: <span data-tw-bind="frequency">10</span></p>
            <input data-tw-bind="frequency" value = '10' type="range" min="1" max="100" class="slider" id="freqRange">
            <p class="bound">Channels</p>
            <select name="channels" id="channels">
                <option value="1">One</option>
                <option value="8">Eight</option>
                <option value="16">Sixteen</option>
            </select>
        </div>
        <div id="synchrony-div">
            <p>Synchrony</p>
            <div><span id = 'sync-dot' class="dot"></span></div>
        </div>
    </div>
</div>
    <div id="visualization-options">
        <button onclick="state=0;">
            3D Brain
        </button>
        <button onclick="state=1;">
            Data Stream
        </button>
        <button onclick="state=3;">
            Group Synchrony
        </button>
        <button id='distortToggle' onclick="distortToggle()">
            <i class="fas fa-play-circle fa-2x"></i>
            <p>Distort Shape</p>
        </button>
    </div>
</div>
</div>

<script>

    let canvas = document.getElementById('webgl');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let gl = canvas.getContext('webgl')
    // shape_array = ['brain', 'voltage', shapes.sphereShell, shapes.sphereShell2, shapes.boxShell, shapes.circularHyperboloid]
    // render_array = [gl.POINTS, gl.POINTS, gl.POINTS, gl.POINTS, gl.POINTS, gl.POINTS]
    let shape_array = ['brain', 'voltage',shapes.sphereShells,shapes.sphereShell]
    let render_array = [gl.POINTS, gl.LINES,gl.POINTS,gl.POINTS]
    let state = 0;
    let prevState;

    // WebGL Variables
    let brainVertices;
    let brainMesh;
    let DESIRED_POINTS = 1e5/2; // 80000
    let REDUCE_POINT_DISPLAY_FACTOR = 200;
    let signal_sustain;
    let resolution;
    let INITIAL_Z_OFFSET = 1.7;
    let VOLTAGE_Z_OFFSET = .5;
    let AUTO_ROTATION_X = 0.0; //0.2;
    let INNER_Z = 2*VOLTAGE_Z_OFFSET;

    let numUsers = 4;

    let displacement = [];
    let disp_flat = [];
    let synchrony = [0];
    SYNCHRONY_BUFFER_SIZE = 100;

    // Point Movement
    let DAMPING = .2;
    let t = 0.0;

    // Signal Generation Variables
    let channels = 1;
    let generate = false;
    let duration = 1 // seconds
    let samplerate = 125; // This is almost definitely wrong
    let generate_interval = Math.round(duration*samplerate); // seconds
    let count = 0;

    // Distortion Variables
    let distort = false;
    let distortion = 0;
    let distortFlag = false;
    let distortIter = 1;

    // Signal Setup
    let signal = new Array(channels);
    let other_signal = new Array(channels);
    for (let chan = 0; chan < channels; chan++){
        signal[chan] = new Array(REDUCE_POINT_DISPLAY_FACTOR).fill(0);
        other_signal[chan] = new Array(REDUCE_POINT_DISPLAY_FACTOR).fill(0);
    }
    let passed_signal = []

    // WebSocket Setup
    let messages = []
    let  url = 'https://brainsatplay.azurewebsites.net/'
    // let url = 'http://localhost:80'
    let socket = io.connect((url))

    $(function () {
        $('form').submit(function(e) {
            e.preventDefault(); // prevents page reloading
            socket.emit('chat message', $('#message').val());
            $('#message').val('');
            return false;
        });
    });

    function initialize() {

        socket.on('chat message', (data) => {
            messages = [...messages, data];
            // you can also do this.messages.push(data)
        });

        socket.on('chat message', function (msg) {
            $('#messages').append($('<li>').text(msg));
        });

        socket.on('bci', passSignal);

        particleBrain()
    }
</script>

</body>
</html>
